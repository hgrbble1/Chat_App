<!DOCTYPE html>
<html lang="en">

<head>
  <title>Mustache Messaging App</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
  <link rel="stylesheet" type="text/css" href="stylesheets/mainWindow_style.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
</head>
<header>
</header>
<main class="container">

  <!-- <div class="row">
  <div class="col s3">
    <p>Hello page layout</p>
    <p>Page layout</p>
    </div>
    <div class="row">
      <div class="col s3">
        <p>page layout</p>
      </div>
    </div>
    <div class="col s9">
      <p>Page layout</p>
      </div>
  <div class="row">
    <ul></ul>
  </div>
</div> -->

  <!-- start of row messages -->
  <div class="row">
    <!-- start of receiving messages -->
    <div class="col s6">
      <ul id="receiving">Received Messages<ul>
    </div>
    <!-- end of receiving messages -->

    <!-- start of sending messages -->
    <div class="col s6">
      <ul class="offset-s2" id="sent">Sent Messages<ul>
    </div>
    <!-- end of receiving messages -->
  </div>
  <!-- end of row messages -->
  </main>

  <footer>
    <div class="container">
    <form>
      <div class="row">
        <div class="col-s12">
          <div class="blue-text text-darken-2 input-field col s12">
            <!--  <i class="material-icons prefix">textsms</i> -->
            <input type="text" id="message" class="blue-text text-darken-2 autocomplete"></input>
            <label for="message">Mustache Message</label>
            <button type="submit" class="btn waves-effect waves-light">Send</button>
          </div>
          <div id='progress' class="progress hide">
            <div id='determiante'class="determinate" style="width: 0%"></div>
          </div>
        </div>
      </div>
    </form>
    </div>


  <script>
  var jsonData;
    const electron = require('electron');
    const {
      ipcRenderer
    } = electron;
    const ulsent = document.querySelector('#sent');
    const form = document.querySelector('form');
    form.addEventListener('submit', sendText);
    window.addEventListener("beforeunload", updateHistoryFile);
    console.log('Im working');

    function sendText(e) {
      e.preventDefault();

      const message = document.querySelector("#message");
      updateHistory(jsonData, message.value, true);
      ulsent.className = 'collection';
      const li = document.createElement('li');
      li.className = 'collection-item';
      const itemText = document.createTextNode(message.value);
      li.appendChild(itemText);
      ulsent.appendChild(li);
      ipcRenderer.send('send:message', message.value)
      message.value = '';
    };

    const ulrec = document.querySelector('#receiving');
    ipcRenderer.on('item:add', function(e, item) {
      ulrec.className = 'collection';
      const li = document.createElement('li');
      li.className = 'collection-item';
      const itemText = document.createTextNode(item);
      li.appendChild(itemText);
      ulrec.appendChild(li);
    });

    ipcRenderer.on('image:add', function(e, item) {
      console.log('i made it here');
      const li = document.createElement('li');
      const img = document.createElement('IMG');
      //var x = document.createElement("IMG");
      img.setAttribute("src", item);
      img.setAttribute("width", "304");
      img.setAttribute("height", "228");
      img.setAttribute("alt", "The Pulpit Rock");
      //document.body.appendChild(x);
      li.className = 'collection-item';
      //const itemText = document.createTextNode(item);
      li.appendChild(img);
      ulrec.appendChild(li);

    });

    ipcRenderer.on('progress:update', function(e, item) {
        const progress = document.querySelector('#progress');
        const determiante = document.querySelector('#determiante');
        if (progress.classList.contains('hide')) {
          progress.classList.remove('hide');
        }
        determiante.style.width = item;

    });

    ipcRenderer.on('progress:done', function(e, item) {
      const progress = document.querySelector('#progress');
      const determiante = document.querySelector('#determiante');
      determiante.style.width = item;
      progress.classList.add('hide');
      // if (progress.classList.contains('hide')) {
      //   progress.classList.remove('hide');
      // }

    });

    function updateHistoryFile(e) {
      var filepath = "history.json";// Previously saved path somewhere
      stringData = JSON.stringify(jsonData);

      if (fs.existsSync(filepath)) {
        fs.unlink(filepath, (err) => {
          if (err) {
              alert("An error ocurred updating the file" + err.message);
              console.log(err);
              return;
            }
            console.log("File succesfully deleted");
          });
        } else {
          alert("This file doesn't exist, cannot delete");
        }
      fs.writeFile(filepath, stringData, (err) => {
            if(err){
                alert("An error ocurred creating the file "+ err.message)
            }

            alert("The file has been succesfully saved");
        });

    }
  </script>
  <script type="text/javascript" src="readfile.js"></script>
  </footer>

</html>
